# nog -- LOG 2015
By spr
<!--@@VERSIONINC@@-->

## 2015-10-22 Upgrade to Meteor 1.2

Upgrading package and the Meteor base release turned out to be trickier than
expected.  A few lessons.

The syntax `package@v1 || v2` can be used in `package.js` to loosen the
dependency constraints.  It may, for example, be useful to accept any `1.x` or
`2.x` versions like `less@1.0.0 || 2.0.0` to avoid unsatisfiable constraints.

Keeping an older `api.versionsFrom()` seems ok, since the versions are only
a lower bound withing the same major version.  Constraints can be
loosened on individual packages if necessary with the  `||` syntax as described
above.

Starting from the example apps seems useful, because they contain fewer
dependencies.  Issues are easier to solve.

A minimal update of the Meteor release is done with `meteor update --release
<version>`.  It seems reasonable to start with this and update more packages
separately.

## 2015-12-23 Local S3 for testing and maybe nog-cloud offline (spr)

fake-s3 <https://github.com/jubos/fake-s3> looks reasonable at first glance.
It has recommendations in the README for production s3 replacements.  Blob post
about fake-s3 <https://snikt.net/blog/2013/10/20/fakes3/>.

s3proxy <https://github.com/andrewgaul/s3proxy> looks interesting, too.
Dockerized version <https://github.com/ritazh/s3proxydocker>.

Riakcs <http://docs.basho.com/riakcs/latest/> looks promising as production
setup.

Skylable <http://www.skylable.com> looks promising as production setup; see
<http://stackoverflow.com/a/32912058>.

## 2015-11-29 Meteor links (spr)

How to scale: <http://joshowens.me/how-to-scale-a-meteor-js-app/>.

## 2015-10-24 How to write a command line tool with Meteor 1.2 (spr)

Writing command line tools in Meteor might be useful, since we already use
Meteor.  The code might be easier to write and read for all of us than bash.
Tools can use Meteor packages as usual.  See links at end of entry for
more.

To create a minimal command line tool with Meteor 1.2, create a new project,
then remove all default packages and add only what we need:

```bash
meteor create cmd
cd cmd
rm -f *.css *.html *.js
echo >.meteor/packages
meteor add meteor coffeescript
```

As an example, create a file `main.coffee` with the following content:

```coffee
{exec} = Npm.require 'child_process'
execSync = Meteor.wrapAsync exec

ls = -> execSync 'ls'

@main = ->
  console.log 'settings:', Meteor.settings
  console.log 'ls:'
  console.log ls()
```

Run the command, passing args through a bash process substitution, with:

```bash
meteor run --once --settings <(echo '{ "argv": ["a", "b", "c"]}')
```

See also:

 - Blog post on writing command line tools with Meteor:
   <http://practicalmeteor.com/writing-command-line-programs-with-meteor/>.
   It refers to the package `practicalmeteor:mcli`
   <https://github.com/practicalmeteor/meteor-mcli>.
 - react-packages helper script in node with npm package `sync`: YouTube
   <https://youtu.be/Jb7ttzdxl30>, source
   <https://github.com/meteor/react-packages/tree/devel/scripts/publish-packages>.

## 2015-10-08 Meteor links (spr)

Easier access to template instance variables:
<https://dweldon.silvrback.com/template-instance>.

Form validation with jQuery plugin:
<http://themeteorchef.com/snippets/validating-forms-with-jquery-validation/>.

## 2015-09-08 Meteor links (spr)

Constellation is an alternative to mongol.  Constellation is completely open
and provides an API for plugins.
<https://github.com/JackAdams/constellation/>.

The Meteor Chef on loading patterns:
<http://themeteorchef.com/snippets/loading-patterns/>.

Blog post on building Meteor app for web and iOS.  Contains interesting tips,
such as pre-render and cache pages; or use jQuery for quick response, followed
by real work in a Meteor template.
<https://hansoftx.com/blog/building-an-ultra-responsive-ui>.

Blog post on Meteor with SSL.  Contains link to SSL quality test that can be
used to test your deployment.
<http://joshowens.me/ssl-and-meteor-js/?utm_medium=referral&utm_source=crater.io>.

Long blog post about Meteor inside docker on Mac OS X:
<http://pem-musing.blogspot.fr/2015/09/meteor-devops-on-osx-with-docker-set.html>

## 2015-07-24 Error handling strategy with meteor-job via ddp (spr)

Initially, I tried to handle any kind of error by reconnecting.
But I failed to reliably reconnect (see details below).

The idea now is to die on any kind of error and implement some basic heartbeat
monitoring to detect if the daemon got stuck, and if so die, too; and rely on
a parent `forever` watchdog to restart the daemon.

Details about reconnecting:

```coffee
DDP = require 'ddp'
JobQueue = require 'meteor-job'

# ...

ddp = new DDP
  host: hostname
  port: port
  ssl: protocol is 'https:'
  autoReconnect: true
  autoReconnectTimer: 10

JobQueue.setDDP ddp
```

`ddp.connect(cb)` must be called once with a callback.  It registers the
callback as an event handler on the ddp object:
<https://github.com/oortcloud/node-ddp-client/blob/c47290885b5142c7060e8ba58f00b862811e585b/lib/ddp-client.js#L310>.
If it was called a second time with the same callback, the callback would be
registered twice.

`autoReconnect` does not handle network errors.  `_connectionFailed` is set to
`false` after a network error,
<https://github.com/oortcloud/node-ddp-client/blob/c47290885b5142c7060e8ba58f00b862811e585b/lib/ddp-client.js#L319>,
which prevent `_recoverNetworkError()` from retrying,
<https://github.com/oortcloud/node-ddp-client/blob/c47290885b5142c7060e8ba58f00b862811e585b/lib/ddp-client.js#L111>.

So I tried to reconnect explicitly with a call to `ddp.connect()` without new
callback:

```coffee
connect = ->
  ddp.connect (err, isReconnect) ->
    if err
      reconnectLater()
      return console.log 'connect error:', err
    console.log 'connected'
    ddplogin() # which calls startProcessJobs()


pendingReconnect = false

reconnectLater = ->
  unless pendingReconnect
    pendingReconnect = true
    reconnect = ->
      console.log 'reconnecting'
      pendingReconnect = false
      ddp.connect()
    setTimeout reconnect, 1000
```

It seemed to work to some extend with the following pro

```coffee
queue = null

processJobsStarted = false
startProcessJobs = ->
  unless processJobsStarted
    processJobsStarted = true
    queue = JobQueue.processJobs 'nogexec.jobs', 'run', (job, done) ->
      console.log 'xxx', job
      console.log 'xxx', job.data
      job.done()
      done()
    console.log queue

connect()
```

But the job queue got stuck with a pending call to `getWork()`,
<https://github.com/vsivsi/meteor-job/blob/15aedc5f526d427564e9988044099b7998403dde/src/job_class.coffee#L144>,
whose callback was not called, and, therefore, no new jobs were processed.

There was no obvious way to detect this condition.  I did not try to figure out
a solution but instead decided to take a different approach.

## 2015-07-23 Production node daemons (spr)

Summary: forever is my favorite choice to get started.  PM2 may be interesting
for a more powerful setup.

Alternatives for running and monitoring node daemons:

 - forever: lib <https://github.com/foreverjs/forever-monitor>, cli
   <https://github.com/foreverjs/forever>.
 - PM2: <https://github.com/Unitech/pm2>.
 - Comparison of forever, nodemon, node-supervisor, node-dev:
   <https://strongloop.com/strongblog/comparison-tools-to-automate-restarting-node-js-server-after-code-changes-forever-nodemon-nodesupervisor-nodedev/>.

Details:

 - Using forever with CoffeeScript:
   <http://codetheory.in/using-coffeescript-over-javascript-in-your-node-js-application-or-module/>.
 - Blob that promotes PM2:
   <http://devo.ps/blog/goodbye-node-forever-hello-pm2/>.

## 2015-07-19 Meteor links: debugging (spr)

Blob post 'easy debugging': <http://joshowens.me/easily-debugging-meteor-js/>.

The Meteor Chef - recipes for day-to-day problems: <http://themeteorchef.com>.

Command line tools with Meteor:
<http://practicalmeteor.com/writing-command-line-programs-with-meteor/>.

## 2015-06-22 S3 upload tests (spr)

9 large files (1 GB AVIs) in parallel from ZIB (1 GigE) to:

 - us-west-2: 20 MB/s
 - eu-central-1: 100 MB/s

The link to Frankfurt seems saturated (more than 100 MB/s cannot be expected
over 1 GigE).

## 2015-06-17 How to debug packages with npm dependencies locally? (spr)

The situation might be confusing, because the same code may be discovered at
various locations in the file system.  The following is a reasonably safe
approach.

Clone the Meteor package to a `packages/` (usually use a symlink).

Clear `.meteor/local`:

    rm -rf .meteor/local/isopacks/ .meteor/local/build/

Start the app.  It will create and populate a folder `.npm/node_modules` in the
cloned Meteor package and re-create the directories in `.meteor/local/`.

Meteor automatically rebuilds when it detects changes to the cloned package
(the content must change; a touch is not sufficient).  However, it won't pick
up changes to `.npm/node_modules`.  You can trigger a rebuild by modifying the
content of the cloned package.

## 2015-06-16 subs-cache as an alternative to subs-manager

See <https://github.com/ccorcos/meteor-subs-cache>.

It's unclear at this point how to combine subscriptions caching with
template-level subscriptions.  See, for example,
<https://forums.meteor.com/t/template-subscribe-and-subsmanager/2003>.

## 2015-06-15 How to run MongoDB explain in Meteor?

Run `explain()`, see
<http://mongodb.github.io/node-mongodb-native/2.0/api/Cursor.html#explain>, on
the raw collection:

```coffee
coll.rawCollection().find(sel).explain (err, res) ->
  console.log 'explanation', res
```

## 2015-06-15 How to handle migrations?

How to handle database migrations, that is to modify existing documents when
a document format changes?

The package `percolate:migrations` seems reasonable.

 - Package `percolate:migrations`:
   <https://github.com/percolatestudio/meteor-migrations/>
 - SO:
   <http://stackoverflow.com/questions/10365496/meteor-how-to-perform-database-migrations>
 - Telescope's approach:
   <https://github.com/TelescopeJS/Telescope/blob/master/packages/telescope-migrations/lib/server/migrations.js>

## 2015-06-15 Reactive publish

The Package `lepozepo:meteor-reactive-publish`, <https://github.com/Lepozepo/meteor-reactive-publish/>, seems useful.

See blog <https://www.discovermeteor.com/blog/reactive-joins-in-meteor/>.

## 2015-06-11 Trick to call init code for new elements (spr)

Some bootstrap components require to run JavaScript on the elements.  Meteor's
`onRendered()` might be too early if the element is inserted reactively.
A trick is to insert a dummy helper that schedules code to be run after the
next flush.  See SO <http://stackoverflow.com/a/10119993>.

```jade
li
  a(href='/settings' data-toggle='tooltip' title='Settings')
    span.glyphicon.glyphicon-cog #{initTooltip}
```

```coffee
Template.header.helpers
  initTooltip: ->
    tpl = Template.instance()
    Tracker.afterFlush ->
      tpl.$('[data-toggle="tooltip"]').tooltip()
    return
```

A better alternative is to use a helper template, whose only purpose is to
initialize the tooltip:

```jade
template(name='withTooltip')
  +Template.contentBlock

template(...)
  ...
  +withTooltip
    a(href='#' title='Settings' data-toggle='tooltip') Link
```

```coffee
Template.withTooltip.onRendered ->
  @$('[data-toggle="tooltip"]').tooltip()
```

## 2015-05-28 Meteor links: searching, URL management (spr)

Easy-Search package seems to be promising:
<http://matteodem.github.io/meteor-easy-search/getting-started/>

Meteorpedia links to searching:
<http://www.meteorpedia.com/read/Fulltext_search>.

Blog post that discusses how to keep the state in the URL.  Seem useful.
<https://meteorhacks.com/meteor-ui-pattern-keeping-app-state-in-the-url>

## 2015-05-09 Pagination blog post on discover meteor (spr)

The following blog post discusses potential problems with paginations and
solutions: <https://www.discovermeteor.com/blog/pagination-problems-meteor/>.

## 2015-05-05 Mongol gotcha (spr)

`msavin:mongol` may not see all collections if it is added after other packages.
To fix this, move mongol closer to the top in `.meteor/packages` before other
packages that instantiate `Mongo.Collection`.

## 2015-05-04 Meteor template-local state gotcha with item list (spr)

Using a `ReactiveVar` on a template instance of an item list of a JavaScript
array did not work as I expected.  I tried a typical template configuration:

    template(name='listView')
      each items
        +itemView

    Template.listView.helpers
      items: -> ...  # return JavaScript array of objects without `_id`.

`itemView` had a button to remove the item after a confirmation.  I tried to
store the confirmation state on a `ReactiveVar`:

    Template.itemView.onCreated ->
      @isDeleting = new ReactiveVar

`isDeleting` was manipulated from the helpers.

Now here is the gotcha: When an item at the top was removed, the template
instance was kept and the data for the items below was moved to the existing
`itemView` template instances.  But the state in the `ReactiveVar` remained at
the original template instance.  The user-perceivable state got corrupted.

The problem is caused by the way how `ObserveSequence` handles objects without
`_id`: It uses the index as the persistent object id and, therefore, fails to
track object identity after removal of items; see
<https://github.com/meteor/meteor/blob/cfdea06e47121e68015dbb758a0627b97a50ef2c/packages/observe-sequence/observe_sequence.js#L295>

Lessons:

Do not naively assume a stable one-to-one relation between template instances
and data.

Attach an `_id` to every object to allow Blaze to track its identity during
sequence updates.

If you have doubts that the automatic mechanism works, manually manage the
correspondence between view state and data.  There are several options that
should work reliably.

The global `Session` can be used with a naming scheme that identifies the
correspondence to the data item and the view element.  This mechanism
is advertised in the Meteor documentation.  `Session` is preserved across a code
push.

If multiple template instances should be displayed at the same time, they could
be called with different names in their data contexts; the name would be
mangled into the `Session` key.  For example:

    .container
      ...
      listView viewName='foo'
      listView viewName='bar'

Instead of `Session`, a file-local `ReactiveDict` could be used together with
a similar naming scheme for the keys.  The naming scheme might be simpler,
since the file locality already provides a scope.  But the state is lost after
a hot code push.

A third reliable options might be a `ReactiveDict` on a controller object that
is instantiated in the `onCreated` callback of a template instance that can be
assumed to remain associated with the same data context.  The controller object
can then be attached to the items' data contexts to make the state available in
the related sub-template instances.  I used a variant of this approach in
`git-like-model/client/templates/editRepo.coffee`.

## 2015-05-01 Meteor debug (spr)

To debug the application, start it with:

    meteor debug \
        --settings _private/settings-localhost-test.json

Then follow the instructions how to connect the debugger GUI:

    open http://localhost:8080/debug?port=5858

Use `debugger` breakpoint statements in your code.

To debug velocity mocha, start with:

    VELOCITY_DEBUG_MIRROR=mocha \
        meteor run \
        --settings _private/settings-localhost-test.json

I could not find out how to debug mocha package tests.

## 2015-04-26 More on auth: OAuth mac, constant time comparison (spr)

IETF draft OAuth MAC scheme in various versions.  v0 is easy to follow, v5 seems
more complicated on first glance.  v0:
<https://tools.ietf.org/html/draft-ietf-oauth-v2-http-mac-00>, v5:
<https://tools.ietf.org/html/draft-ietf-oauth-v2-http-mac-05>.

Npm package for constant time buffer comparison:
<https://www.npmjs.com/package/buffer-equal-constant-time>.

## 2015-04-21 How to control mocha test selection? (spr)

To control the tests selection, tag tests with labels of format `_TAG_`, use
`nog-test` and control the selection via Meteor.settings.  The following, for
example, excludes all test that are labeled `_AWS_`, which is used to indicate
that the tests will make a request to AWS:

    {
        "public": {
            "tests": {
                "mocha": {
                    "grep": "_AWS_",
                    "invert": true
                }
            }
        }
    }

This requires a patched to `mocha-package`:

    diff --git a/server.js b/server.js
    index fd51c9c..02ff75e 100644
    --- a/server.js
    +++ b/server.js
    @@ -134,7 +134,10 @@ if (Velocity && Velocity.registerTestingFramework){
         global.chai = Npm.require("chai");
         // enable stack trace with line numbers with assertions
         global.chai.Assertion.includeStack = true;
    -    global.mocha = new Mocha({ui: "bdd", reporter: MochaWeb.MeteorCollectionTestReporter});
    +    opts = {};
    +    opts = _.extend(opts, MochaWeb.options);
    +    opts = _.extend(opts, {ui: "bdd", reporter: MochaWeb.MeteorCollectionTestReporter});
    +    global.mocha = new Mocha(opts);
         setupGlobals();
       }

## 2015-04-18 Exporting from Meteor packages that use CoffeeScript (spr)

Use normal variables (without `@`) together with `api.export()` in `package.js`.
See <https://github.com/meteor/meteor/tree/master/packages/coffeescript>,
<https://github.com/meteor/meteor/tree/master/packages/coffeescript-test-helper>.

## 2015-04-18 Alternatives to symmetric HMAC (spr)

HMAC is symmetric and requires the secret key on the server.  The easiest way is
to store it in the database.  A more secure way could be to store it encrypted,
so that an attacker cannot retrieve the secret keys from a database dump.  It
could still access them with full control over the server.

Asymmetric signature verification would be substantially more complex and
expensive to compute.  Since a production setup should use SSL anyway,
another asymmetric verification is probably unnecessary.

 - Stackoverflow on HMAC and asymmetric alternatives:
   <http://security.stackexchange.com/questions/34891/why-a-symmetric-key-for-hmac>

## 2015-04-17 Fixed Mocha timeouts (spr)

Be sure to have my fixes if you use suite-specific and test-specific mocha
timeouts: <https://github.com/mad-eye/meteor-mocha-web/pull/157>.

## 2015-04-17 How to automatically test file upload? Use nightwatch! (spr)

I believe that file upload cannot be tested with Velocity (mocha), because the
value of an input file element cannot be set from JavaScript.  The browser
refuses to run:

    MochaWeb?.testOnly ->
      describe 'upload', ->
        it 'uploads a file', (done) ->
          e = $('input#files')
          # Setting a value programmatically on a file input is forbidden.
          e.val('/Users/bzfproha/2015/meteor-spikes_fuimages_2015/nog-repo/apps/blob-test/tests/a.txt')

It, however, works from nightwatch:

    resolve = require('path').resolve
    module.exports = {
      "uploading a single file works" : function (client) {
        client
          .url("http://127.0.0.1:3000")
          .waitForElementVisible("body", 1000)
          .waitForElementVisible("input#files", 1000)
          .setValue('input#files', resolve(__dirname + '/a.txt'))
          // TODO: test that upload succeeded.
          .end();
      }
    };

## 2015-04-16 Meteor testing (spr)

The most promising solution for package testing is Mocha (also see separate
entry on how to get started with packages):

    cd app-with-tests
    meteor test-packages --driver-package respondly:test-reporter
    open http://localhost:3000

To run the tests once and report results to the console, use:

    meteor test-packages --velocity --driver-package respondly:test-reporter

This approach uses the same, well documented framework 'mocha' that is also
recommended for velocity end-to-end tests.

 - Blog post <https://blog.respond.ly/testing-meteor-packages-with-mocha/>.
 - YouTube presentation <https://www.youtube.com/watch?v=ZxCir4lp5CI>.
 - GitHub branch `meteor-mocha-web/packageTest`:
   <https://github.com/mad-eye/meteor-mocha-web/tree/packageTest>.

The most promising solution for end-to-end testing the application is Velocity:

    cd app-with-tests
    meteor

Click on the icon in the top right corner to display the test report.  To report
test results to the console, add the following package:

    meteor add velocity:console-reporter

To run tests once and report results to the console, use:

    meteor run --test

The end-to-end tests use Velocity with Mocha:

 - main links: <http://velocity.meteor.com>, <http://www.meteortesting.com>,
   <http://www.meteortesting.com/chapter/velocity>.
 - Talk that recommends Mocha: <http://youtu.be/ToiMvbHkvfY?t=18m54s>.

Mocha can be configured to select a subset of tests:

    mocha.grep(<string> | <regex>)  # Select only matching tests.
    mocha.invert()  # Invert grep, select tests that do not match.

I failed to use the Meteor nightwatch package (see separate entry).  But
nightwatch directly works.  It seems to be a reasonable option to test the full
app directly in different browsers.  It might also be a useful approach to
checking whether a deployed app works as expected (for example have a regular
cron job that checks whether the zib publication statistics works; see
`nightwatch/zibpubstat-test.js`).

## 2015-04-16 Failed to use clinical-nightwatch; but nightwatch directly works (spr)

Follow instructions at <https://github.com/awatson1978/clinical-nightwatch>.

    cd app-with-tests
    mkdir tests/nightwatch
    echo '{}' >tests/nightwatch/globals.json
    mkdir tests/nightwatch/logs
    mkdir tests/nightwatch/commands
    mkdir tests/nightwatch/commands/components
    mkdir tests/nightwatch/commands/methods
    mkdir tests/nightwatch/assertions
    mkdir tests/nightwatch/walthroughs
    mkdir tests/nightwatch/walkthroughs
    rmdir tests/nightwatch/walthroughs/

I fixed the nightwatch shell sample script by adding `mkdir node_modules` above
the `npm install`.

`../tools/bin/nightwatch` got stuck during the test.  The selenium server seemed
to work: It reported that a new selenium server was started and opened a new
Firefox window.  But the window remained empty.

    command to run: .meteor/local/build/node_modules/nightwatch/bin/nightwatch -e default -c .meteor/local/build/programs/server/assets/packages/clinical_nightwatch/nightwatch_from_app_root.json
    Running Nightwatch...

    Starting selenium server... started - PID:  56360

    [Home] Test Suite
    =================

    Running:  Hello World

    Connection refused! Is selenium server started?

Nightwatch directly (not as Meteor package) works; see
<http://nightwatchjs.org/guide#installation>:

    cd nightwatch
    mkdir node_modules
    npm install nightwatch

    # start selenium in a separate console.
    mkdir selenium
    cd selenium
    wget http://selenium-release.storage.googleapis.com/2.45/selenium-server-standalone-2.45.0.jar
    java -jar selenium-server-standalone-2.45.0.jar

    mkdir -p examples/custom-commands
    nightwatch -t home-test.js
    ./node_modules/.bin/nightwatch -t home-test.js

Expected output:

    [Home Test] Test Suite
    ======================

    Running:  Hello World
    ✔ Element <body> was visible after 473 milliseconds.
    ✔ Testing if the page title equals "app-with-tests".

    OK. 2 assertions passed. (2.997s)

Another test that checks the ZIB publication statistics:

    ./node_modules/.bin/nightwatch -t zibpubstat-test.js

## 2015-04-14 Extending the Meteor account system: two-factor auth (spr)

Blog post that discusses in detail how to extend the Meteor auth system with
a custom two-factor auth procedure.  It gives an impression of relevant
undocumented Meteor methods.
<http://ravis.me/2014/12/02/meteor-js-two-factor-authentication/>.

## 2015-04-13 Don't use X- (spr)

RFC 6648 deprecates the use of the x prefix; see
<http://tools.ietf.org/html/rfc6648>.  The new recommendation is to choose
reasonable names, assuming that they might become a standard at some point.

## 2015-04-13 Spike: getting started with packages (spr)

The goal of this spike is to develop a non-trivial package 'nog-auth' (nog is
the new codename of our project: nog's not git), which adds an API-key-based
authenticating scheme similar to the one described in the design overview, and
tests of the authentication scheme with a REST API and a ddp client.

    mkdir -p packages
    cd git-like-model
    meteor create --package nog-auth
    cd packages
    mv nog-auth/ ../../packages/
    ln -s ../../packages/nog-auth .
    cd ..
    meteor add nog-auth

Edit files in `packages/nog-auth/`.

To enable CoffeeScript, add `api.use` directives in `package.js`:

    Package.onUse(function(api) {
      ...
      api.use('coffeescript');
      ...
    });

    Package.onTest(function(api) {
      ...
      api.use('coffeescript');
      ...
    });

To use mocha for package testing; see blog post
<https://blog.respond.ly/testing-meteor-packages-with-mocha/> and YouTube
presentation <https://www.youtube.com/watch?v=ZxCir4lp5CI>:

    Package.onTest(function(api) {
        api.use(['mike:mocha-package', 'practicalmeteor:chai']);  // instead of tinytest.
        ...
    }

and run tests with:

    meteor test-packages --driver-package respondly:test-reporter

To use munit for testing (instead of Tinytest); see
<https://github.com/practicalmeteor/meteor-munit>:

    Package.onTest(function(api) {
        api.use('practicalmeteor:munit');  // instead of tinytest.
        ...
    }

To enable basic describe-it style for Tinytest; see
<http://www.peterellisjones.com/post/101970705880/unit-testing-meteor-packages-with-tinytest>:

    Package.onTest(function(api) {
        api.use('peterellisjones:describe');  // instead of tinytest.
        ...
    }

## 2015-04-13 Packages links (spr)

Meteor doc on writing packages: <http://docs.meteor.com/#/full/writingpackages>.

Meteor API doc `package.js`: <http://docs.meteor.com/#/full/packagejs>.

How to declare static files?  Use `isAsset`:
<http://stackoverflow.com/a/24151637>.

Organizing a large app: <http://meteor.redandivory.com/#/>.

See testing links below.

npm in Meteor packages:
<https://coderwall.com/p/srvdta/using-npm-modules-in-meteor>.

Dan Dascalescu: Packaging 3rd party libraries properly - December Devshop SF:
<https://www.youtube.com/watch?v=g-idz8UPtDM>, <http://slides.com/dandv>.

## 2015-04-13 Testing links (spr)

Testing Meteor Packages with Mocha is my preferred solution so far.  This
approach uses the same, well documented framework mocha that is also recommended
for velocity.

 - Blog post <https://blog.respond.ly/testing-meteor-packages-with-mocha/>.
 - YouTube presentation <https://www.youtube.com/watch?v=ZxCir4lp5CI>.
 - GitHub branch `meteor-mocha-web/packageTest`:
   <https://github.com/mad-eye/meteor-mocha-web/tree/packageTest>.

Meteor cookbook 'testing':
<https://github.com/awatson1978/meteor-cookbook/blob/master/cookbook/test-driven-development.md>

Testing with Velocity: <http://velocity.meteor.com>,
<http://www.meteortesting.com>, <http://www.meteortesting.com/chapter/velocity>.
Talk that recommends Mocha: <http://youtu.be/ToiMvbHkvfY?t=18m54s>.

End-to-end acceptance testing with nightwatch:
<https://github.com/awatson1978/clinical-nightwatch>.

munit seems to be a useful extension of tinytest (for package testing):
<https://github.com/practicalmeteor/meteor-munit>.

Meteor cookbook 'writing unit tests with tiny test':
<https://github.com/awatson1978/meteor-cookbook/blob/master/cookbook/writing.unit.tests.md>.

EventedMind 'Testing Packages with Tinytest':
<https://www.eventedmind.com/feed/meteor-testing-packages-with-tinytest>.

Presentation 'Peter Jones: Testing with Tinytest - December Devshop London':
<https://www.youtube.com/watch?v=fq4VEkdvGEE>.  Notable parts: everything is a package
<https://youtu.be/fq4VEkdvGEE?t=13m51s>, temporary collections
<https://youtu.be/fq4VEkdvGEE?t=10m41s>, templates
<https://youtu.be/fq4VEkdvGEE?t=13m8s>.

Internal test-related Meteor packages:

 - tinytest <https://github.com/meteor/meteor/tree/devel/packages/tinytest>.
 - test-helpers <https://github.com/meteor/meteor/blob/devel/packages/test-helpers>.

meteortesting blog post 'The 7 Testing Modes of Meteor':
<http://www.meteortesting.com/blog/e72fe/the-7-testing-modes-of-meteor>.

Blog post 'Unit testing Meteor packages with Tinytest'; explains how to add
`describe` and `it`:
<http://www.peterellisjones.com/post/101970705880/unit-testing-meteor-packages-with-tinytest>,
Meteor package <https://atmospherejs.com/peterellisjones/describe>.

Fixtures / Test data in the velocity README:
<https://github.com/meteor-velocity/velocity>.

Blog post 'Bullet-proof Meteor applications with Velocity, Unit Testing,
Integration Testing and Jasmine':
<https://doctorllama.wordpress.com/2014/09/22/bullet-proof-internationalised-meteor-applications-with-velocity-unit-testing-integration-testing-and-jasmine/>.

## 2015-04-13 Packages to try (spr)

Moment.js Parse, validate, manipulate, and display dates in JavaScript:
<http://momentjs.com>, <https://atmospherejs.com/momentjs/moment>.

Font Awesome: <http://fontawesome.io>, <https://atmospherejs.com/fortawesome>.

## 2015-04-13 Demo of job execution via slurm (spr)

See ZIB internal `nog-sup` repo.

## 2015-04-12 Communicating with slurm (spr)

See ZIB internal `nog-sup` repo.

## 2015-04-11 Using low-level DDP (spr)

See `tasksd-slurm-ddp` for example how DDP could be used to run jobs in slurm.

 - Authenticate DDP (requires `meteor add accounts-base`):
   <http://stackoverflow.com/questions/16729992/authenticating-with-meteor-via-ddp-and-srp>.
 - Extending meteor authentication:
   <https://meteorhacks.com/extending-meteor-accounts.html>.
 - ddp client: npm <https://www.npmjs.com/package/ddp>, GitHub
   <https://github.com/oortcloud/node-ddp-client>.
 - meteor-job-collection is an implementation of a job queue that uses DDP to
   execute jobs: <https://github.com/vsivsi/meteor-job-collection>.

## 2015-04-10 node rest client packages (spr)

`request` has far more downloads than the others and seems reasonably easy to
use.

 - request <https://www.npmjs.com/package/request>
 - restler <https://www.npmjs.com/package/restler>
 - node-rest-client <https://www.npmjs.com/package/node-rest-client>

## 2015-04-10 How to use npm packages in main application (spr)

Meteor by default supports npm packages only in packages.  For production
applications, I think that using packages is the right way.  But for spikes, it
might be handy to use npm packages directly from the main app, which can be
achieved by `meteorhacks:npm` <https://github.com/meteorhacks/npm>:

    meteor add meteorhacks:npm
    meteor  # Start once to create package.js.
    # edit package.js.
    meteor  # Start again to install npm package.

    # Ignore automatically installed packages.
    echo '/packages/npm-container/' >>.gitignore

## 2015-04-08 More on API design (spr)

Getting started:

 - Good presentation about how to design a REST API: Many notable
   recommendations that we should consider: URL vX scheme; use camelCase; always
   use ISO UTC time with 'Z'; use href for links; provide option `?expand=` to
   embed linked documents; error reporting with details and help; ...
   .  <https://www.youtube.com/watch?v=hdSrT4yjS1g>.
 - Blog post 'designing a RESTful Web API':
   <https://scotch.io/bar-talk/designing-a-restful-web-api>.
 - Blog post about API with node and Express:
   <https://scotch.io/tutorials/build-a-restful-api-using-node-and-express-4>.
 - Postman: <http://www.getpostman.com>
 - Tutorial about APIs with node and MongoDB with nice diagram of ExpressJS
   stack:
   <http://adrianmejia.com/blog/2014/10/01/creating-a-restful-api-tutorial-with-nodejs-and-mongodb/>.

Singular or Plural:

 - SO to use singular for database tables: <http://stackoverflow.com/a/5841297>.
 - SO about REST API:
   <http://stackoverflow.com/questions/6845772/rest-uri-convention-singular-or-plural-name-of-resource-while-creating-it>.
 - Blog post 'designing a RESTful Web API' proposes to vary depending on
   context: <https://scotch.io/bar-talk/designing-a-restful-web-api>.
 - My current preference is always plural.

Links:

 - REST APIs must by hypertext-driven:
   <http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven>.
 - Links in REST: <https://gist.github.com/miyagawa/1912431>.
 - JSON linking with HAL:
   <http://blog.stateless.co/post/13296666138/json-linking-with-hal>.
 - HAL spec: <http://stateless.co/hal_specification.html>.
 - JSend: Recommendation how to format JSON returned from REST call.  I like the
   idea to separate `{status: ..., data: ...}`.
   <http://labs.omniti.com/labs/jsend>.

## 2015-03-14 How to hack on a package, locally (spr)

Getting started lightening talk: <https://www.youtube.com/watch?v=flGh4nHnETg>.

## 2015-03-14 Official Meteor bootstrap package (spr)

Instead of `mizzao:bootstrap-3`, we should switch to the official bootstrap
package `twbs:bootstrap`; see <https://atmospherejs.com/mizzao/bootstrap-3> and
<https://www.youtube.com/watch?v=g-idz8UPtDM>.

## 2015-03-11 Meteor links (spr)

DDP analyzer: <https://meteorhacks.com/discover-meteor-ddp-in-realtime.html>.
It's useful in the same window that you run meteor:

    ddp-analyzer-proxy &
    DDP_DEFAULT_CONNECTION_URL=http://localhost:3030 meteor

YouTube 'everything is a package', nice idea how to test template logic:
<https://youtu.be/fq4VEkdvGEE?t=13m12s>.

Meteor admin: YouTube <https://www.youtube.com/watch?v=zU6Oj5_pIKM>, GitHub
<https://github.com/doctorpangloss/meteor-admin/>, Atmosphere
<https://atmospherejs.com/doctorpangloss/admin>.

Iron router cheat sheet:
<https://gentlenode.com/journal/meteor-11-iron-router-cheatsheet/18>.  Some
things may not work as described, such as globbing (use a regex instead).

Chrome tool for inspecting and profiling Blaze: Intro on YouTube
<https://www.youtube.com/watch?v=0pO96dEySF0>, code from GitHub
<https://github.com/Slava/blaze-tools>, how to load the extension
<https://developer.chrome.com/extensions/getstarted#unpacked>.  The blaze
inspector seems useful.

Useful tool Mongol to interactively display subscribed docs:
YouTube <https://www.youtube.com/watch?v=kMCoP0kNGwU>, demo and download
<http://mongol.meteor.com>.

## 2015-03-11 How to download and save a sha1 blob to a specific local filename? (spr)

S3 URLs can be configured to send a `Content-Disposition` header, which can be
used to specify a local filename, see
<http://www.w3.org/Protocols/rfc2616/rfc2616-sec19.html> and
<http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getObject-property>.
A reasonable implementation for downloading without opening a new window is
described at
<http://pixelscommander.com/en/javascript/javascript-file-download-ignore-content-type/>.
The complete solution is:

    # Client
    Meteor.call 'getBlobDownloadURL', {sha1, filename}, (err, res) ->
      link = document.createElement 'a'
      link.href = res
      link.download = ''
      e = document.createEvent 'MouseEvents'
      e.initEvent 'click', true, true
      link.dispatchEvent e

    # Server
    return S3.getSignedDownloadUrl
      Bucket: cfg.bucket
      Key: opts.sha1
      ResponseContentDisposition: 'attachment; filename="' + opts.filename + '"'

Even when using the `Content-Disposition` header, the attribute `download` needs
to be set to avoid the following warning in Chrome:

    Resource interpreted as Document but transferred with MIME type application/octet-stream

S3 response header may also be useful to specify a content type.

The download attribute is not supported in Safari, see
<http://caniuse.com/#feat=download>.

## 2015-03-10 REST (spr)

 - cook book: <http://restcookbook.com>
 - GitHub API: <https://developer.github.com/v3/>

## 2015-03-06 Links on subscriptions (spr)

 - MeteorHacks on subscription optimization:
   <https://meteorhacks.com/meteor-subscription-optimizations.html>.
 - MeteorHacks on subscription manager:
   <https://meteorhacks.com/subscriptions-manager-is-here.html>.
 - MeteorHacks on subscription manager for iron router:
   <https://meteorhacks.com/subscription-manager-for-iron-router.html>.
 - Subscription manager: <https://github.com/meteorhacks/subs-manager>.
 - Template-level subscriptions:
   <https://www.discovermeteor.com/blog/template-level-subscriptions/>.
 - Publish anything: <http://meteorcapture.com/publishing-anything/>,
   <http://meteorcapture.com/publishing-data-from-an-external-api/>.

## 2015-02-17 Options for deploying a meteor app (spr)

My current impression about deployment options:

 - Meteor: use meteor.com for testing and demos.  Use Modulus as PaaS unless we find
   a specific reason to use a different PaaS.  Consider hosting on a VM (or
   Docker container) as described in the DigitalOcean guide.
 - RabbitMQ: Use CloudAMQP as RabbitMQ PaaS (Little Lemur free; or Tough Tiger
   for $19 / month).  Consider hosting on VM or Docker container if we want to
   avoid PaaS costs.
 - Object storage: Start with S3; switch to ZIB openstack when available.
 - Compute at ZIB (docker on vsl4; consider ZIB openstack when available).

Blog post with good discussion of options:
<http://joshowens.me/modulus-vs-heroku-vs-digital-ocean/>.

Detailed blog post about deployment:
<https://medium.com/@david_sykora/taking-meteor-apps-into-production-with-modulus-compose-and-codeship-54236d7f0cc>.

Modulus: <https://modulus.io>, YouTube tutorial video
<https://www.youtube.com/watch?v=nVUdSihPUlk>.

Demetorize: <https://www.discovermeteor.com/blog/modulus-demeteorizer/>.

Meteor Up: <https://github.com/arunoda/meteor-up>.

Kadira meteor performance monitoring: <https://kadira.io>.

Instead of DigitalOcean, we could use a container at ZIB or an openstack VM when
the become available.

DigitalOcean guide to deploying a meteor app:
<https://www.digitalocean.com/community/tutorials/how-to-deploy-a-meteor-js-application-on-ubuntu-14-04-with-nginx>.

CloudAMQP pricing: <https://www.cloudamqp.com/plans.html>.

## 2015-02-14 How to automatically submit form? (spr)

Use approach like auto-form: submit on change.  See code at
<https://github.com/aldeed/meteor-autoform>.  Map enter to blur.

Update on key press without flooding server as used in todo,
<https://github.com/meteor/meteor/blob/1ac45850de3e5e379d9e0211fc1ac8a09420a76f/examples/todos/client/templates/todos-item.js#L39>,
didn't work reliably.  Some key presses got lost, probably because the modified
values arrived reactively from the server and the form got updated.

## 2015-02-14 Trello CSS guide (spr)

Trello's guide how to use CSS:
<https://gist.github.com/bobbygrace/9e961e8982f42eb91b80>.

## 2015-02-14 Links (spr)

PDF generation in the browser: <http://pdfkit.org>.

Recommended package from Chaser presentation
<http://youtu.be/G-s7Vf13gtQ?t=16m13s>:

 - handlebars-server: render on the server, e.g. for mail.
 - simple-schema: validate mongo doc structure.
 - synced-cron: run jobs.

Testing with Velocity: <http://velocity.meteor.com>,
<http://www.meteortesting.com>.  Talk that recommends Mocha:
<http://youtu.be/ToiMvbHkvfY?t=18m54s>.

Pretend that meteor is SQL: <http://youtu.be/ToiMvbHkvfY?t=13m51s>:
simple-schema, collections2, precolate:migrations.

MeteorHacks: <https://meteorhacks.com>.

BulletProof Meteor: <https://bulletproofmeteor.com/basics/introduction>.

Common mistakes: <https://dweldon.silvrback.com/common-mistakes>.

Blog post on forms: <http://www.neo.com/2014/05/23/reactive-forms-in-meteor-js>.

Cheat sheets:
<http://www.3rank.com/cheat-sheets-for-programmers-and-developers/>.

Manuel Schoebel's Blog: <http://www.manuel-schoebel.com/blog>.  I(spr), in
particular, liked the post on package-only app structure:
<http://www.manuel-schoebel.com/blog/meteorjs-package-only-app-structure-with-mediator-pattern>.

Nice, a bit advanced example that uses iron router controllers:
<http://www.naturaily.com/blog/post/how-to-create-blog-in-meteor-not-for-complete-beginners>.

## 2015-02-01 How to organize view state of list of items? (spr)

Idea: Parent template has client-side collection for viewing state.  It acts as
a controller that modifies state through this collection.  Items get their state
by inspecting the parent's client-side collection.

Accessing the parent template is not obvious.  I didn't find a mechanism that is
built into Meteor.  Best options:

 - Custom foreach that stores parent: <http://stackoverflow.com/a/13851721>;
   or variant in which the parent foreach augments the data context of the
   items, so that they do not need to access the parent (see comment to
   stackoverflow answer).

 - Helper function via view to provide access:
   <http://stackoverflow.com/a/27949941>

 - Access internals:
   <https://groups.google.com/d/msg/meteor-talk/zdWP4uVUVgA/g2a7AdoG9j4J>

 - Don't write reusable templates.  Put additional state instead at file scope.

 - Don't use a separate template for the items.  Handle everything in the
   parent.

 - `Template.created()` is the right place to initialize per-template-instance
   data.

## 2015-02-01 Meteor links (spr)

 - How to gray out items until confirmed: <http://stackoverflow.com/a/10082888>
 - Intro talk to security with meteor:
   <https://www.youtube.com/watch?v=79uMp-S23MA>

## 2015-01-31 MongoDB ids and Meteor (spr)

 Interesting discussion of id object type vs string:
 <https://groups.google.com/d/msg/meteor-talk/f-ljBdZOwPk/UGxzC0QlD3cJ>.

## 2015-01-31 Jade instead of HTML (spr)

With meteor-jade from <https://github.com/mquandalle/meteor-jade>

## 2015-01-29 How to model many-to-many relations? (spr)

 - EventedMind tutorial:
   <https://www.eventedmind.com/feed/meteor-how-to-publish-a-many-to-many-relationship>
 - Package to publish relations:
   <https://github.com/svasva/meteor-publish-with-relations>
 - Package to simplify access to relations:
   <https://github.com/dburles/meteor-collection-helpers>

## 2015-01-27 How to organize config settings? (spr)

Best idea so far: Use `Meteor.settings` together with `check`.  Wherever config
settings are required, put a starting block at the top of the file like:

    cfg =
      foo: Meteor.settings?.public?.topic?.foo ?
        <default>

      bar: Meteor.settings?.topic?.bar ?
        <default>

      baz: Meteor.settings?.topic?.baz ?
        Meteor.settings?.public?.topic?.baz ?
        <default>

    checkCfg = (cfg) ->
      check cfg.foo, Match.Where (x) ->
        check x, Number
        x >= 5 and x <= 10

      check cfg.baz, ...

      if Meteor.isServer
        check cfg.bar, ...

    checkCfg cfg

The pattern double checks `<default>` and serves as input validation for the
settings file.  The named function `checkCfg` helps to understand call stacks if
a check fails.

To find all settings, grep for `Meteor.settings`.

## 2015-01-27 How to organize a meteor app? (spr)

  - Blog entry that looks useful:
    <http://joshowens.me/how-to-organize-your-meteor-js-app/>

## 2015-01-25 Complete S3 multipart upload with sha1s (spr)

It uses rusha to compute client-side sha1s.  It detects and keeps track of
multiple uploads of the same blob; all clients get reactive notifications.
Pending uploads will be canceled after a timeout if the same blob is uploaded
again.

A regular job that checks for pending uploads and deletes them is missing.

Run with:

    cd s3-multipart-upload-2/
    meteor run --settings .private/settings.json

## 2015-01-25 JS links (spr)

 - Good tutorials: <http://www.html5rocks.com/en/tutorials/>.
 - Web workers: <http://www.html5rocks.com/en/tutorials/workers/basics/>.
 - Promises: <http://www.html5rocks.com/en/tutorials/es6/promises/>.

## 2015-01-24 Meteor links (spr)

 - Instant search with package `search-source`:
   <https://meteorhacks.com/implementing-an-instant-search-solution-with-meteor.html>.
 - Subscription manager:
   <https://meteorhacks.com/subscriptions-manager-is-here.html>.
 - Template level subscriptions:
   <https://www.discovermeteor.com/blog/template-level-subscriptions/>.

## 2015-01-24 rusha SHA1 (spr)

Performance of rusha on MacBook Pro, 2.7 GHz Intel Core i7:

 - Chrome 41: 100 MB/s.
 - Firefox 35: 150 MB/s.

## 2015-01-24 Reactive values (spr)

ReactiveArray from <http://reactivearray.meteor.com> seems useful.

Blog post on reactivity options:
<http://richsilv.github.io/meteor/meteor-reactive-data-types/>.

Meteor doc about reactivity: <http://manual.meteor.com/#deps>.

EventedMind reactive uploader:
<https://www.eventedmind.com/feed/meteor-file-uploader-part-8-reactive-upload-progress>.

## 2015-01-24 User roles management (spr)

The package 'roles' looks promising: <https://atmospherejs.com/alanning/roles>.

For user management, maybe use package 'accounts-admin-ui-bootstrap-3':
<https://atmospherejs.com/mrt/accounts-admin-ui-bootstrap-3>.

See example in subdir `researchdata-github-oauth`.

## 2015-01-20 Why does second multipart upload fail?

**Solution:** Use the request interface.  It avoids the spurious callback and
seems to work reliably.

    fut = new Future
    req = ...
    req.on 'success', (res) ->
        fut.return res.data
    req.on 'error', (err) ->
        fut.throw err
    req.send()
    fut.wait()

**Problem:** With an additional `console.log` in aws-sdk's `request.js`:

    self.emit(self._asm.currentState, function() {
        console.log(self._asm.currentState);
        done(self.response.error);
    });

The sequence of events should be:

    I20150120-06:57:58.543(1)? startMultipartUpload { name: 'test.dat', size: 5, maxNStartParts: 1 } { totalSize: 5, nParts: 1, partSize: 5 }
    I20150120-06:57:58.558(1)? validate
    I20150120-06:57:58.562(1)? build
    I20150120-06:57:58.562(1)? afterBuild
    I20150120-06:57:58.564(1)? sign
    I20150120-06:57:59.496(1)? send
    I20150120-06:57:59.496(1)? validateResponse
    I20150120-06:57:59.501(1)? extractData
    I20150120-06:57:59.501(1)? success
    I20150120-06:57:59.502(1)? { Bucket: 'zib-researchdata2',
    I20150120-06:57:59.502(1)?   Key: 'test.dat',
    I20150120-06:57:59.502(1)?   UploadId: 'AsK4Xbd1DjNKnAEedOgoOD2owwyws0pbKXHEDT4Pz8J0sozkFTuqpVdMEq7HFXcCujoZGFnhFlUmH6OG2H9OQQ1iwZL..71L8J5sPVReGp90GtBWW0VrcC9ZahhE0lMS' }

But during the second upload, `startMultipartUpload` already returns after sign

    I20150120-06:58:13.500(1)? startMultipartUpload { name: 'test.dat', size: 5, maxNStartParts: 1 } { totalSize: 5, nParts: 1, partSize: 5 }
    I20150120-06:58:13.502(1)? validate
    I20150120-06:58:13.503(1)? build
    I20150120-06:58:13.503(1)? afterBuild
    I20150120-06:58:13.503(1)? sign
    I20150120-06:58:13.507(1)? { Bucket: 'zib-researchdata2',
    I20150120-06:58:13.508(1)?   Key: 'test.dat',
    I20150120-06:58:13.508(1)?   UploadId: 'AsK4Xbd1DjNKnAEedOgoOD2owwyws0pbKXHEDT4Pz8J0sozkFTuqpVdMEq7HFXcCujoZGFnhFlUmH6OG2H9OQQ1iwZL..71L8J5sPVReGp90GtBWW0VrcC9ZahhE0lMS' }
    I20150120-06:58:13.514(1)? validate
    I20150120-06:58:13.514(1)? build
    I20150120-06:58:13.514(1)? afterBuild
    I20150120-06:58:13.514(1)? sign
    I20150120-06:58:13.515(1)? [ { partNumber: 1,
    I20150120-06:58:13.515(1)?     start: 0,
    I20150120-06:58:13.516(1)?     end: 5,
    I20150120-06:58:13.517(1)?     url: 'https://zib-researchdata2.s3.amazonaws.com/test.dat?AWSAccessKeyId=AKIAJF5JTE23GY5Y6VUA&Expires=1421734393&Signature=D4LEEkO%2BYS0jXPG6RedzolxdVwA%3D&partNumber=1&uploadId=AsK4Xbd1DjNKnAEedOgoOD2owwyws0pbKXHEDT4Pz8J0sozkFTuqpVdMEq7HFXcCujoZGFnhFlUmH6OG2H9OQQ1iwZL..71L8J5sPVReGp90GtBWW0VrcC9ZahhE0lMS' } ]
    I20150120-06:58:14.316(1)? send
    I20150120-06:58:14.317(1)? validateResponse
    I20150120-06:58:14.317(1)? extractData
    I20150120-06:58:14.317(1)? success

And then again after 'success', which causes the error:

    W20150120-06:58:14.318(1)? (STDERR)
    W20150120-06:58:14.319(1)? (STDERR) /Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/request.js:33
    W20150120-06:58:14.319(1)? (STDERR)           throw err;
    W20150120-06:58:14.319(1)? (STDERR)                 ^
    W20150120-06:58:14.321(1)? (STDERR) Error: Future resolved more than once
    W20150120-06:58:14.321(1)? (STDERR)     at Object.Future.return (/Users/bzfproha/.meteor/packages/meteor-tool/.1.0.38.z83ibe++os.osx.x86_64+web.browser+web.cordova/meteor-tool-os.osx.x86_64/dev_bundle/server-lib/node_modules/fibers/future.js:154:10)
    W20150120-06:58:14.321(1)? (STDERR)     at Object.<anonymous> (/Users/bzfproha/.meteor/packages/meteor-tool/.1.0.38.z83ibe++os.osx.x86_64+web.browser+web.cordova/meteor-tool-os.osx.x86_64/dev_bundle/server-lib/node_modules/fibers/future.js:242:16)
    W20150120-06:58:14.322(1)? (STDERR)     at Request.<anonymous> (/Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/request.js:351:18)
    W20150120-06:58:14.322(1)? (STDERR)     at Request.callListeners (/Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/sequential_executor.js:100:18)
    W20150120-06:58:14.322(1)? (STDERR)     at Request.emit (/Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/sequential_executor.js:77:10)
    W20150120-06:58:14.322(1)? (STDERR)     at Request.emit (/Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/request.js:605:14)
    W20150120-06:58:14.322(1)? (STDERR)     at Request.transition (/Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/request.js:21:12)
    W20150120-06:58:14.322(1)? (STDERR)     at AcceptorStateMachine.runTo (/Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/state_machine.js:14:12)
    W20150120-06:58:14.323(1)? (STDERR)     at /Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/state_machine.js:26:10
    W20150120-06:58:14.323(1)? (STDERR)     at Request.<anonymous> (/Users/bzfproha/.meteor/packages/peerlibrary_aws-sdk/.2.1.6_2.vjxpii++os+web.browser+web.cordova/npm/node_modules/aws-sdk/lib/request.js:23:9)

I thought that the call to sign a URL might leave some internal state modified
that causes problems.  But it happens also if I remove the call to sign.

## 2015-01-17 Which meteor aws-sdk package to use? (spr)

Based on the github network, `peerlibrary:aws-sdk`,
<https://github.com/peerlibrary/meteor-aws-sdk>, seems to be the most actively
maintained meteor package for aws-sdk.

`meteor search aws-sdk` found the following packages:

    bozhao:aws-sdk            SDK for AWS services including Amazon S3, Amazon EC2, DynamoDB, and Amazon SWF
    eluck:aws-sdk             SDK for AWS services including Amazon S3, Amazon EC2, DynamoDB, and Amazon SWF
    mrt:aws-sdk-js            Meteor smart package for AWS SDK node.js
    natestrauser:aws-sdk-npm  aws-sdk npm packaged for meteor.
    peerlibrary:aws-sdk       SDK for AWS services including Amazon S3, Amazon EC2, DynamoDB, and Amazon SWF
    risul:aws-sdk             AWS SDK for NodeJS - packaged for Meteor
    rosh93:aws-sdk            Wrapper for npm AWS SDK
    stevezhu:aws-sdk          SDK for AWS services including Amazon S3, Amazon EC2, DynamoDB, and Amazon SWF

## 2015-01-13 S3 multipart upload (spr)

AWS recommends uploading files larger than 100 MB using multipart upload, see
<http://docs.aws.amazon.com/AmazonS3/latest/dev/uploadobjusingmpu.html>

Examples to get signed URL with official JavaScript AWS API `aws-sdk`:
<http://docs.aws.amazon.com/AWSJavaScriptSDK/guide/node-examples.html#Amazon_S3__Getting_a_pre-signed_URL_for_a_getObject_operation__getSignedUrl_>

`AWS.S3.ManagedUpload` in `lib/s3/managed_upload.js` in aws-sdk source
implements managed multipart upload.

Example implementation for multipart upload from browser:
<https://github.com/ienzam/s3-multipart-upload-browser>

nodejs package `s3-upload-stream` for multipart upload:
<https://github.com/nathanpeck/s3-upload-stream>

Library `EvaporateJS` for multipart upload from browser:
<https://github.com/TTLabs/EvaporateJS>

This code might also be helpful:
<https://github.com/Lepozepo/S3/blob/master/server/methods.coffee>

This C# implementation contains a lot of details that might be helpful:
<http://gauravmantri.com/2014/01/06/create-pre-signed-url-using-c-for-uploading-large-files-in-amazon-s3/>.
The ETAGs for the parts are mandatory.

Change the CORS configuration on the S3 bucket to expose the ETag header (see
<http://docs.aws.amazon.com/AWSJavaScriptSDK/guide/browser-configuring.html#Cross-Origin_Resource_Sharing__CORS_>):

    <?xml version="1.0" encoding="UTF-8"?>
    <CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/">
        <CORSRule>
            <AllowedOrigin>*</AllowedOrigin>
            <AllowedMethod>PUT</AllowedMethod>
            <AllowedMethod>POST</AllowedMethod>
            <AllowedMethod>GET</AllowedMethod>
            <AllowedMethod>HEAD</AllowedMethod>
            <MaxAgeSeconds>3000</MaxAgeSeconds>
            <AllowedHeader>*</AllowedHeader>
            <ExposeHeader>ETag</ExposeHeader>
        </CORSRule>
    </CORSConfiguration>

Run spike with:

    cd s3-multipart-upload/
    meteor run --settings .private/settings.json

## 2015-01-11 Meteor Links

 - Manual: <http://manual.meteor.com>
 - Docs: <http://docs.meteor.com/#/full/>
 - Unofficial FAQs: <https://github.com/oortcloud/unofficial-meteor-faq>
 - Package to generate fake data: <https://github.com/anticoders/meteor-fake/>
 - Discover Meteor blog: <https://www.discovermeteor.com/blog>
 - Autoform package: <https://github.com/aldeed/meteor-autoform>
 - Meteor tips:
   <https://medium.com/@Dominus/meteor-tips-and-workarounds-b791151ce870>

## 2015-01-10 Using GitHub API from Meteor (spr)

Use package `bruz:github-api`.  `mrt:github` does not work.

 - See example in `researchdata-github-oauth`.
 - node-github: <https://github.com/mikedeboer/node-github>
 - node-github doc: <http://mikedeboer.github.io/node-github/>
 - GitHub API doc: <https://developer.github.com/v3/>

## 2015-01-08 rabbitmq lowlevel (spr)

Idea: use RabbitMQ directly without celery.  It will allow more precise control
over job requests and responses and avoid the complexity of another intermediate
layer.

See RabbitMQ tutorial on work queues for Python
<http://www.rabbitmq.com/tutorials/tutorial-two-python.html>, and adaption to
node:
<https://github.com/rabbitmq/rabbitmq-tutorials/tree/master/javascript-nodejs>.

Install python3-pika for Python 3 (pika failed with Python 3).

    manager
    brew install python3
    pip3 install python3-pika
    exit

Register at <https://www.cloudamqp.com> and start free instance on AWS (other
services may not support free queues).  Browse to instance details and copy URL.

Start worker in the first console:

    cd rabbitmq-lowlevel/worker
    export AMQP_URL=<paste-url>
    python3 worker.py

You should see one connection in the RabbitMQ management console.

Submit task in the second console using python:

    cd rabbitmq-lowlevel/worker
    export AMQP_URL=<paste-url>

Submit tasks from meteorapp.  Create
`rabbitmq-lowlevel/meteorapp/.private/settings.json` with:

    { "AMQP_URL": "<url>" }

Then start meteor app with:

     meteor run --settings .private/settings.json

or deploy with:

     meteor deploy --settings .private/settings.json <url>

You should two connections in the RabbitMQ management console.  The button
should submit jobs.  The job list should immediately update and show the result
upon job completion.

## 2015-01-08 How to reset deployed Meteor db? (spr)

Delete app and redeploy:

    meteor deploy <url> --delete
    meteor deploy <url>

## 2015-01-07 node <-> mq <-> python (spr)

Idea:

 - Use RabbitMQ as service from https://www.cloudamqp.com (free plan should be
   sufficient for demo).
 - Use Celery for Python task execution, see
   <https://www.cloudamqp.com/docs/python.html>, <http://www.celeryproject.org>,
   <http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html>.
 - Celery tasks can be submitted from node with
   https://github.com/mher/node-celery.

Follow instructions in
<http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html>.

Install celery:

    manager
    brew install python3
    pip3 install celery
    exit

    python3
    >>> import celery
    >>> # ok

Register at <https://www.cloudamqp.com> and start free instance on AWS (other
services may not support free queues).  Browse to instance details and copy URL.

Start worker in first console:

    cd node-mq-python/worker
    export AMQP_URL=<paste-url>
    celery -A tasks worker --loglevel=info

You should see two connections in the RabbitMQ management console.

Submit task in second console:

    cd node-mq-python/worker
    export AMQP_URL=<paste-url>
    python3
    >>> from tasks import add
    >>> add.delay(4, 4)

You should see in the first console that the task got processed.

Submit task and get result:

    >>> result = add.delay(4, 4)
    >>> result.ready()
    >>> result.get()

`acks_late` seem to be useful to reliably execute tasks if workers may disappear
(see
<http://celery.readthedocs.org/en/latest/userguide/workers.html#stopping-the-worker>).

Try node client based on node-celery <https://github.com/mher/node-celery>.
Celery needs to be configured to send JSON to work with node-celery.

    cd node-mq-python/client
    npm install node-celery
    coffee client.coffee

You should see a result object.

Meteor celery should be useful for direct integration with meteor:
<https://github.com/nathan-muir/meteor-celery>.

Create `node-mq-python/meteorapp/.private/settings.json` with:

    { "AMQP_URL": "<url>" }

Then start meteor app with:

     meteor run --settings .private/settings.json

or deploy with:

     meteor deploy --settings .private/settings.json <url>

You should three connections in the RabbitMQ management console.  The button
should submit jobs.  The job list should immediately update and immediately show
the result upon job completion.

`meteor-celery` does not return the task id.  It should be relatively easy to
modify it to return the `celery_result.taskId` together with the future (see
<https://github.com/nathan-muir/meteor-celery/blob/8f84673a21a9be2134677070933f4087b258237d/server.js#L117>.

## 2015-01-05 GitHub OAuth

Docs:

 - Meteor doc: <http://docs.meteor.com/#/full/meteor_loginwithexternalservice>
 - Blog with GitHub OAuth example: <http://moduscreate.com/diving-into-meteorjs/>
 - Blog with chat app that uses GitHub OAuth: <http://sebastiandahlgren.se/2013/07/17/tutorial-writing-your-first-metor-application/>
 - Blog with various OAuth examples: <http://themeteorchef.com/recipes/roll-your-own-authentication/>

Register GitHub application.  The settings can later be updated.

 - At <https://github.com/settings/applications>:
 - Application name: researchdata
 - Homepage URL: http://localhost:3000
 - Authorization callback URL: http://localhost:3000

The application registration page displays the Client ID and the Client Secret.
Store them in `researchdata-github-oauth/.pivate/settings.json`:

    {
        "GITHUB_CLIENT_ID": "<id>",
        "GITHUB_CLIENT_SECRET": "<secret>"
    }

Then start Meteor with:

    cd researchdata-github-oauth
    meteor run --settings .private/settings.json

## 2015-01-04 Sync and Async in Meteor

Meteor uses fibers to emulate sync behavior:
<https://www.discovermeteor.com/blog/understanding-sync-async-javascript-node/>

## 2015-01-04 Initialized repo (stdtools clone)

<!-- vim: set sw=4: -->
